# 数据结构

## 轻重链剖分  

```cpp
void dfs1(int x, int pre) {
	siz[x] = 1; mson[x] = 0;
	dth[x] = dth[pre] + 1;
	fa[x] = pre;
	for(auto y : son[x]) if(y != pre) {
		dfs1(y, x);
		siz[x] += siz[y];
		if(!mson[x] || siz[y] > siz[mson[x]]) 
			mson[x] = y;
	}
}
void dfs2(int x, int pre, int ntp) {
	id[x] = ++idcnt;
	ltp[x] = ntp;
	if(mson[x]) dfs2(mson[x], x, ntp);
	for(auto y : son[x]) {
		if(y == mson[x] || y == pre) continue;
		dfs2(y, x, y);
	}
}
void link_modify(int x, int y, int z) {
	z %= mod;
	while(ltp[x] != ltp[y]) {
		dth[ltp[x]] < dth[ltp[y]] && (x ^= y ^= x ^= y);
		modify(1, n, id[ltp[x]], id[x], 1, z);
		x = fa[ltp[x]];
		
	}
	dth[x] < dth[y] && (x ^= y ^= x ^= y);
	modify(1, n, id[y], id[x], 1, z);
}
int link_query(int x, int y) {
	int ans = 0;
	while(ltp[x] != ltp[y]) {
		dth[ltp[x]] < dth[ltp[y]] && (x ^= y ^= x ^= y);
		ans = (1ll * ans + query(1, n, id[ltp[x]], id[x], 1)) % mod;
		x = fa[ltp[x]];
	}
	dth[x] < dth[y] && (x ^= y ^= x ^= y);
	ans = (1ll * ans + query(1, n, id[y], id[x], 1)) % mod;
	return ans;
}
```

## 二维树状数组

+ 矩阵修改，矩阵查询 



查询前缀和，公式：  

令$d[i][j]$为差分数组，定义：

$d[i][j] = a[i][j] - (a[i - 1][j] - a[i][j - 1] - a[i - 1][j])$

$\sum_{i = 1}^{x}\sum_{j - 1}^{y} a[i][j] = (x + 1) * (y + 1) * d[i][j]- (y + 1) * i * d[i][j]+ d[i][j] * i * j$

```cpp
void modify(int x, int y, int v) {
	for(int rx = x; rx <= n; rx += rx & -rx) {
		for(int ry = y; ry <= m; ry += ry & -ry) {
			tree[rx][ry][0] += v;
			tree[rx][ry][1] += v * x;
			tree[rx][ry][2] += v * y;
			tree[rx][ry][3] += v * x * y;
		}
	}
}
void range_modify(int x, int y, int xx, int yy, int v) {
	modify(xx + 1, yy + 1, v);
	modify(x, yy + 1, -v);
	modify(xx + 1, y, -v);
	modify(x, y, v);
}
int query(int x, int y) {
	int ans = 0;
	for(int rx = x; rx; rx -= rx & -rx) {
		for(int ry = y; ry; ry -= ry & -ry) {
			ans += (x + 1) * (y + 1) * tree[rx][ry][0]
			- tree[rx][ry][1] * (y + 1) - tree[rx][ry][2] * (x + 1)
			+ tree[rx][ry][3];
		}
	}
	return ans;
}
int range_query(int x, int y, int xx, int yy) {
	return query(xx, yy) + query(x - 1, y - 1)
		- query(x - 1, yy) - query(xx, y - 1);
}
```

